function fitCurve(t,r,e){if(!Array.isArray(t))throw new TypeError("First argument should be an array");if(t.forEach(function(r){if(!Array.isArray(r)||r.some(function(t){return"number"!=typeof t})||r.length!==t[0].length)throw Error("Each point should be an array of numbers. Each point should have the same amount of numbers.")}),t=t.filter(function(r,e){return 0===e||!r.every(function(r,a){return r===t[e-1][a]})}),t.length<2)return[];var a=t.length,n=createTangent(t[1],t[0]),s=createTangent(t[a-2],t[a-1]);return fitCubic(t,n,s,r,e)}function fitCubic(t,r,e,a,n){var s,u,m,i,o,h,c,f,l,d,p,b,v,y=20;if(2===t.length)return b=maths.vectorLen(maths.subtract(t[0],t[1]))/3,s=[t[0],maths.addArrays(t[0],maths.mulItems(r,b)),maths.addArrays(t[1],maths.mulItems(e,b)),t[1]],[s];if(u=chordLengthParameterize(t),I=generateAndReport(t,u,u,r,e,n),s=I[0],i=I[1],h=I[2],a>i)return[s];if(a*a>i)for(m=u,o=i,c=h,v=0;y>v;v++){if(m=reparameterize(s,t,m),g=generateAndReport(t,u,m,r,e,n),s=g[0],i=g[1],h=g[2],a>i)return[s];if(h===c){var _=i/o;if(_>.9999&&1.0001>_)break}o=i,c=h}return p=[],f=maths.subtract(t[h-1],t[h+1]),f.every(function(t){return 0===t})&&(f=maths.subtract(t[h-1],t[h]),A=[-f[1],f[0]],f[0]=A[0],f[1]=A[1]),l=maths.normalize(f),d=maths.mulItems(l,-1),p=p.concat(fitCubic(t.slice(0,h+1),r,l,a,n)),p=p.concat(fitCubic(t.slice(h),d,e,a,n));var I,g,A}function generateAndReport(t,r,e,a,n,s){var u,m,i;return u=generateBezier(t,e,a,n,s),o=computeMaxError(t,u,r),m=o[0],i=o[1],s&&s({bez:u,points:t,params:r,maxErr:m,maxPoint:i}),[u,m,i];var o}function generateBezier(t,r,e,a){var n,s,u,m,i,o,h,c,f,l,d,p,b,v,y,_,I,g=t[0],A=t[t.length-1];for(n=[g,null,null,A],s=maths.zeros_Xx2x2(r.length),b=0,v=r.length;v>b;b++)_=r[b],I=1-_,u=s[b],u[0]=maths.mulItems(e,3*_*(I*I)),u[1]=maths.mulItems(a,3*I*(_*_));for(m=[[0,0],[0,0]],i=[0,0],b=0,v=t.length;v>b;b++)_=r[b],u=s[b],m[0][0]+=maths.dot(u[0],u[0]),m[0][1]+=maths.dot(u[0],u[1]),m[1][0]+=maths.dot(u[0],u[1]),m[1][1]+=maths.dot(u[1],u[1]),y=maths.subtract(t[b],bezier.q([g,g,A,A],_)),i[0]+=maths.dot(u[0],y),i[1]+=maths.dot(u[1],y);return o=m[0][0]*m[1][1]-m[1][0]*m[0][1],h=m[0][0]*i[1]-m[1][0]*i[0],c=i[0]*m[1][1]-i[1]*m[0][1],f=0===o?0:c/o,l=0===o?0:h/o,p=maths.vectorLen(maths.subtract(g,A)),d=1e-6*p,d>f||d>l?(n[1]=maths.addArrays(g,maths.mulItems(e,p/3)),n[2]=maths.addArrays(A,maths.mulItems(a,p/3))):(n[1]=maths.addArrays(g,maths.mulItems(e,f)),n[2]=maths.addArrays(A,maths.mulItems(a,l))),n}function reparameterize(t,r,e){return e.map(function(e,a){return newtonRaphsonRootFind(t,r[a],e)})}function newtonRaphsonRootFind(t,r,e){var a=maths.subtract(bezier.q(t,e),r),n=bezier.qprime(t,e),s=maths.mulMatrix(a,n),u=maths.sum(maths.squareItems(n))+2*maths.mulMatrix(a,bezier.qprimeprime(t,e));return 0===u?e:e-s/u}function chordLengthParameterize(t){var r,e,a,n=[];return t.forEach(function(t,s){r=s?e+maths.vectorLen(maths.subtract(t,a)):0,n.push(r),e=r,a=t}),n=n.map(function(t){return t/e})}function computeMaxError(t,r,e){var a,n,s,u,m,i,o,h;n=0,s=t.length/2;var c=mapTtoRelativeDistances(r,10);for(m=0,i=t.length;i>m;m++)o=t[m],h=find_t(r,e[m],c,10),u=maths.subtract(bezier.q(r,h),o),a=u[0]*u[0]+u[1]*u[1],a>n&&(n=a,s=m);return[n,s]}function find_t(t,r,e,a){if(0>r)return 0;if(r>1)return 1;for(var n,s,u,m,i,o=1;a>=o;o++)if(r<=e[o]){m=(o-1)/a,u=o/a,s=e[o-1],n=e[o],i=(r-s)/(n-s)*(u-m)+m;break}return i}function createTangent(t,r){return maths.normalize(maths.subtract(t,r))}var __reflect=this&&this.__reflect||function(t,r,e){t.__class__=r,e?e.push(r):e=[r],t.__types__=t.__types__?e.concat(t.__types__):e},mapTtoRelativeDistances=function(t,r){for(var e,a=[0],n=t[0],s=0,u=1;r>=u;u++)e=bezier.q(t,u/r),s+=maths.vectorLen(maths.subtract(e,n)),a.push(s),n=e;return a=a.map(function(t){return t/s})},maths=function(){function t(){}return t.zeros_Xx2x2=function(t){for(var r=[];t--;)r.push([0,0]);return r},t.mulItems=function(t,r){return t.map(function(t){return t*r})},t.mulMatrix=function(t,r){return t.reduce(function(t,e,a){return t+e*r[a]},0)},t.subtract=function(t,r){return t.map(function(t,e){return t-r[e]})},t.addArrays=function(t,r){return t.map(function(t,e){return t+r[e]})},t.addItems=function(t,r){return t.map(function(t){return t+r})},t.sum=function(t){return t.reduce(function(t,r){return t+r})},t.dot=function(r,e){return t.mulMatrix(r,e)},t.vectorLen=function(t){return Math.hypot.apply(Math,t)},t.divItems=function(t,r){return t.map(function(t){return t/r})},t.squareItems=function(t){return t.map(function(t){return t*t})},t.normalize=function(t){return this.divItems(t,this.vectorLen(t))},t}();__reflect(maths.prototype,"maths");var bezier=function(){function t(){}return t.q=function(t,r){var e=1-r,a=maths.mulItems(t[0],e*e*e),n=maths.mulItems(t[1],3*e*e*r),s=maths.mulItems(t[2],3*e*r*r),u=maths.mulItems(t[3],r*r*r);return maths.addArrays(maths.addArrays(a,n),maths.addArrays(s,u))},t.qprime=function(t,r){var e=1-r,a=maths.mulItems(maths.subtract(t[1],t[0]),3*e*e),n=maths.mulItems(maths.subtract(t[2],t[1]),6*e*r),s=maths.mulItems(maths.subtract(t[3],t[2]),3*r*r);return maths.addArrays(maths.addArrays(a,n),s)},t.qprimeprime=function(t,r){return maths.addArrays(maths.mulItems(maths.addArrays(maths.subtract(t[2],maths.mulItems(t[1],2)),t[0]),6*(1-r)),maths.mulItems(maths.addArrays(maths.subtract(t[3],maths.mulItems(t[2],2)),t[1]),6*r))},t}();__reflect(bezier.prototype,"bezier");