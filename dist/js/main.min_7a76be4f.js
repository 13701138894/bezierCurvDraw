var __reflect=this&&this.__reflect||function(t,e,n){t.__class__=e,n?n.push(e):n=[e],t.__types__=t.__types__?n.concat(t.__types__):n},__extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);n.prototype=e.prototype,t.prototype=new n},__awaiter=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))(function(r,o){function a(t){try{h(i.next(t))}catch(e){o(e)}}function s(t){try{h(i["throw"](t))}catch(e){o(e)}}function h(t){t.done?r(t.value):new n(function(e){e(t.value)}).then(a,s)}h((i=i.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function n(t){return function(e){return i([t,e])}}function i(n){if(r)throw new TypeError("Generator is already executing.");for(;h;)try{if(r=1,o&&(a=o[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return h.label++,{value:n[1],done:!1};case 5:h.label++,o=n[1],n=[0];continue;case 7:n=h.ops.pop(),h.trys.pop();continue;default:if(a=h.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){h=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){h.label=n[1];break}if(6===n[0]&&h.label<a[1]){h.label=a[1],a=n;break}if(a&&h.label<a[2]){h.label=a[2],h.ops.push(n);break}a[2]&&h.ops.pop(),h.trys.pop();continue}n=e.call(t,h)}catch(i){n=[6,i],o=0}finally{r=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,o,a,s,h={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},DrawConst=function(){function t(){}return t.MaxError=10,t.Tension=.5,t.NumOfSeg=100,t}();__reflect(DrawConst.prototype,"DrawConst");var DrawCurveControl=function(){function t(){}return t.getInstance=function(){return t._instance?t._instance:(t._instance=new t,t._instance)},t.prototype.init=function(t){this._container=t,this._wireList=[],this._container.touchEnabled=!0,this._container.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBeginHandler,this),this._tempLine=new DrawTempLine(t)},t.prototype.onTouchBeginHandler=function(){this._container.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMoveHandler,this),this._container.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEndHandler,this),this._container.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onTouchEndHandler,this)},t.prototype.onTouchMoveHandler=function(t){var e=new egret.Point(t.stageX,t.stageY);this._tempLine.addPoint(e)},t.prototype.onTouchEndHandler=function(){this._container.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMoveHandler,this),this._container.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEndHandler,this),this._container.removeEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onTouchEndHandler,this),this.unselectAllWire(),this.isCanCreateWire()&&this.createWire(),this._tempLine.clear()},t.prototype.unselectAllWire=function(){this._wireList.forEach(function(t){t.unselect()})},t.prototype.isCanCreateWire=function(){return this.createOriginalPointsData().length>=2},t.prototype.createWire=function(){var t=this.createOriginalPointsData(),e=this.createBezierCurvePointsData(t),n=this.createDrawPointsData(e),i=new Wire(this._container,{thickness:5,color:65280,alpha:1});i.draw({originalPointsData:t,bezierCurvePointsData:e,drawPointsData:n}),this._wireList.push(i)},t.prototype.createOriginalPointsData=function(){var t=this._tempLine.getPointList();return t.map(function(t){return[t.x,t.y]})},t.prototype.createBezierCurvePointsData=function(t){if(t.length<2)return[];var e=fitCurve(t,DrawConst.MaxError,null);return e.reduce(function(t,e){if(0===t.length){var n=e[0];t.push.apply(t,n)}var i=e[3];return t.push.apply(t,i),t},[])},t.prototype.createDrawPointsData=function(t){return DrawCurveCore.curve(t,DrawConst.Tension,DrawConst.NumOfSeg)},t.prototype.addBezierCurvePoint=function(t,e){var n=this.slicePointsData(e),i=this.getIndexOfLine(t,n),r=[t.x,t.y],o=2*(i+1);(a=e.bezierCurvePointsData).splice.apply(a,[o,0].concat(r));var a},t.prototype.getIndexOfLine=function(t,e){for(var n=5,i=0;i<e.length;i++)for(var r=e[i],o=0;o<r.length;o++){var a=r[o],s=r[o+1];if(s){var h=this.getPointIsInLine(t,a,s,n);if(h)return i}}},t.prototype.slicePointsData=function(t){for(var e=t.bezierCurvePointsData.slice(),n=t.drawPointsData.slice(),i=[],r=0,o=e.length;o>r;r+=2)for(var a={x:e[r],y:e[r+1]},s=[],h=2,c=n.length;c>h;h+=2){var u={x:n[h],y:n[h+1]};if(a.x===u.x&&a.y===u.y){i.push(s),n=n.slice(h);break}s.push(u)}return i},t.prototype.getPointIsInLine=function(t,e,n,i){var r=(n.x-e.x)*(t.x-e.x)+(n.y-e.y)*(t.y-e.y);if(0>=r)return!1;var o=(n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y);if(r>=o)return!1;var a=r/o,s=e.x+(n.x-e.x)*a,h=e.y+(n.y-e.y)*a;return Math.sqrt((t.x-s)*(t.x-s)+(h-t.y)*(h-t.y))<=i},t.prototype.updateAllWire=function(){this._wireList.forEach(function(t){t.updateStyle()})},t}();__reflect(DrawCurveControl.prototype,"DrawCurveControl");var DrawCurveCore=function(){function t(){}return t.curve=function(t,e,n){function i(t,i,r){for(var o,a=2;r>a;a+=2){var h=t[a],u=t[a+1],p=t[a+2],l=t[a+3],d=(p-t[a-2])*e,_=(l-t[a-1])*e,f=(t[a+4]-h)*e,v=(t[a+5]-u)*e;for(o=0;n>o;o++){var g=o<<2,y=i[g],E=i[g+1],w=i[g+2],T=i[g+3];c[s++]=y*h+E*p+w*d+T*f,c[s++]=y*u+E*l+w*_+T*v}}}void 0===e&&(e=.5),void 0===n&&(n=100);var r,o=1,a=t.length,s=0,h=(a-2)*n+2+0,c=new Float32Array(h),u=new Float32Array(4*(n+2)),p=4;for(r=t.slice(0),r.unshift(t[1]),r.unshift(t[0]),r.push(t[a-2],t[a-1]),u[0]=1;n>o;o++){var l=o/n,d=l*l,_=d*l,f=2*_,v=3*d;u[p++]=f-v+1,u[p++]=v-f,u[p++]=_-2*d+l,u[p++]=_-d}return u[++p]=1,i(r,u,a),a=t.length-2,c[s++]=t[a],c[s]=t[a+1],c},t}();__reflect(DrawCurveCore.prototype,"DrawCurveCore");var TempLineStyleConst;!function(t){t[t.thickness=5]="thickness",t[t.color=16711680]="color",t[t.alpha=1]="alpha"}(TempLineStyleConst||(TempLineStyleConst={}));var DrawTempLine=function(){function t(t){this._pointList=[],this._line=new egret.Shape,t.addChild(this._line)}return t.prototype.clear=function(){this._pointList=[],this.update()},t.prototype.addPoint=function(t){this._pointList.push(t),this.update()},t.prototype.getPointList=function(){return this._pointList.slice()},t.prototype.update=function(){var t=this,e=this._pointList[0],n=this._pointList.slice(1);this._line.graphics.clear(),this._pointList.length<=1||(this._line.graphics.lineStyle(TempLineStyleConst.thickness,TempLineStyleConst.color,TempLineStyleConst.alpha),this._line.graphics.moveTo(e.x,e.y),n.forEach(function(e){t._line.graphics.lineTo(e.x,e.y)}),this._line.graphics.endFill())},t}();__reflect(DrawTempLine.prototype,"DrawTempLine");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.loadResource()];case 1:return e.sent(),this.createGameScene(),[4,platform.login()];case 2:return e.sent(),[4,platform.getUserInfo()];case 3:return t=e.sent(),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return n.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return n.sent(),this.stage.removeChild(t),[3,4];case 3:return e=n.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){this.createBg(),this.initContorlBar(),DrawCurveControl.getInstance().init(this)},e.prototype.createBg=function(){var t=new egret.Shape;t.graphics.beginFill(0,1),t.graphics.drawRect(0,0,3e3,3e3),t.graphics.endFill(),this.addChild(t)},e.prototype.initContorlBar=function(){var t=document.querySelector("#errorInput"),e=document.querySelector("#errorValue");t.addEventListener("input",function(){var t=parseInt(this.value);e.innerText=t,DrawConst.MaxError=t,DrawCurveControl.getInstance().updateAllWire()});var n=document.querySelector("#tensionInput"),i=document.querySelector("#tensionValue");n.addEventListener("input",function(){var t=parseInt(this.value);i.innerText=t,DrawConst.Tension=t/100,DrawCurveControl.getInstance().updateAllWire()});var r=document.querySelector("#numSegmentsInput"),o=document.querySelector("#numSegmentsValue");r.addEventListener("input",function(){var t=parseInt(this.value);o.innerText=t,DrawConst.NumOfSeg=t,DrawCurveControl.getInstance().updateAllWire()})},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var Wire=function(){function t(t,e){this._isMove=!1,this._isFirstMove=!0,this._dragPointList=[],this._wireStyle=e,this._selectColor="0xcccccc",this._unselectColor=e.color,this._line=new egret.Shape,this._container=t,t.addChild(this._line),this._line.touchEnabled=!0,this._line.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBeginHandler,this)}return t.prototype.onTouchBeginHandler=function(t){t.stopPropagation(),t.stopImmediatePropagation(),this._tempTouchBeginPoint={x:t.stageX,y:t.stageY},this._container.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMoveHandler,this),this._container.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEndHandler,this),this._container.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onTouchEndHandler,this)},t.prototype.onTouchMoveHandler=function(t){t.stopPropagation(),t.stopImmediatePropagation(),this._isMove=!0,this._isFirstMove&&(DrawCurveControl.getInstance().addBezierCurvePoint(this._tempTouchBeginPoint,this._drawInfo),this.update(),this._isFirstMove=!1,this._tempDragPoint=this.getWireDragPointByPoint(this._tempTouchBeginPoint)),this._tempDragPoint&&(this._tempDragPoint.x=t.stageX,this._tempDragPoint.y=t.stageY,this.moveDragPoint(t.stageX,t.stageY,this._tempDragPoint.getIndex()))},t.prototype.onTouchEndHandler=function(t){t.stopPropagation(),t.stopImmediatePropagation(),this._isMove||this.select(),this._isMove=!1,this._isFirstMove=!0,this._tempDragPoint=null,this._container.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMoveHandler,this),this._container.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEndHandler,this),this._container.removeEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onTouchEndHandler,this)},t.prototype.select=function(){this._wireStyle.color=this._selectColor,this.updateLine(this._drawInfo.drawPointsData)},t.prototype.unselect=function(){this._wireStyle.color=this._unselectColor,this.updateLine(this._drawInfo.drawPointsData)},t.prototype.draw=function(t){this._drawInfo=t,this.update()},t.prototype.update=function(){this.updateLine(this._drawInfo.drawPointsData),this.updateDragPoint()},t.prototype.updateDragPoint=function(){for(var t=this._dragPointList.length-1;t>=0;t--){var e=this._dragPointList[t];e&&(e.dispose(),this._dragPointList.splice(t,1))}for(var n=this._drawInfo.bezierCurvePointsData.length,i=0;n>i;i+=2){var r=this._drawInfo.bezierCurvePointsData[i],o=this._drawInfo.bezierCurvePointsData[i+1],a=new WireDragPoint(i,this);this._container.addChild(a),a.x=r,a.y=o,this._dragPointList.push(a)}},t.prototype.updateLine=function(t){var e={x:t[0],y:t[1]},n=t.slice(2);this._line.graphics.clear(),this._line.graphics.lineStyle(this._wireStyle.thickness,this._wireStyle.color,this._wireStyle.alpha),this._line.graphics.moveTo(e.x,e.y);for(var i=0;i<n.length;i+=2)this._line.graphics.lineTo(n[i],n[i+1]);this._line.graphics.endFill()},t.prototype.moveDragPoint=function(t,e,n){this._drawInfo.bezierCurvePointsData[n]=t,this._drawInfo.bezierCurvePointsData[n+1]=e,this._drawInfo.drawPointsData=DrawCurveControl.getInstance().createDrawPointsData(this._drawInfo.bezierCurvePointsData),this.updateLine(this._drawInfo.drawPointsData)},t.prototype.getWireDragPointByPoint=function(t){for(var e=this._dragPointList.length,n=0;e>n;n++){var i=this._dragPointList[n];if(i.x===t.x&&i.y===t.y)return i}return null},t.prototype.updateStyle=function(){this._drawInfo.bezierCurvePointsData=DrawCurveControl.getInstance().createBezierCurvePointsData(this._drawInfo.originalPointsData),this._drawInfo.drawPointsData=DrawCurveControl.getInstance().createDrawPointsData(this._drawInfo.bezierCurvePointsData),this.update()},t}();__reflect(Wire.prototype,"Wire");var WireDragPoint=function(t){function e(e,n){var i=t.call(this)||this;return i._index=e,i._wire=n,i.initShape(),i._shape.touchEnabled=!0,i._shape.addEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBeginHandler,i),i}return __extends(e,t),e.prototype.onTouchBeginHandler=function(t){t.stopPropagation(),t.stopImmediatePropagation(),this.parent.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMoveHandler,this),this.parent.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEndHandler,this),this.parent.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onTouchEndHandler,this)},e.prototype.onTouchMoveHandler=function(t){t.stopPropagation(),t.stopImmediatePropagation(),this.x=t.stageX,this.y=t.stageY,this._wire.moveDragPoint(t.stageX,t.stageY,this._index)},e.prototype.onTouchEndHandler=function(t){t.stopPropagation(),t.stopImmediatePropagation(),this.parent.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMoveHandler,this),this.parent.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEndHandler,this),this.parent.removeEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onTouchEndHandler,this)},e.prototype.initShape=function(){this._shape=new egret.Shape,this._shape.graphics.beginFill(16711680,1),this._shape.graphics.drawCircle(0,0,5),this._shape.graphics.endFill(),this.addChild(this._shape)},e.prototype.dispose=function(){this.parent.removeChild(this),this._shape.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBeginHandler,this)},e.prototype.getIndex=function(){return this._index},e}(egret.DisplayObjectContainer);__reflect(WireDragPoint.prototype,"WireDragPoint");